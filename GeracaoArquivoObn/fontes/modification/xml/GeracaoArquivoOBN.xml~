<?xml version="1.0" encoding="ISO-8859-1"?>
<modification>
  <name>Geracao Arquivo OBN</name>
  <id>GeracaoArquivoOBN</id>
  <ecidade-version>2.3.39</ecidade-version>
  
  <file path='func_empagegera.php'>
    <operation>
      <search><![CDATA[<!-- [Inicio plugin GeracaoArquivoOBN - parte1] -->]]></search>
      <add position="after">
        <![CDATA[
<tr>
  <td><b>Mostrar registros: </b>
  </td>
  <td>
   <? 
     $aFiltroMovimentos = array("pendencia"=>"Somente com pendencia", "todos"=>"Todos");
     db_select("filtroMovimentos", $aFiltroMovimentos, true, 1);
   ?>
  </td>
</tr>
        ]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN - parte2] */]]></search>
      <add position="after">
        <![CDATA[
if (isset($filtroMovimentos) && $filtroMovimentos == "pendencia") {

  $where .= " and exists (select 1 
                            from empagemov 
                                 inner join empage            on empage.e80_codage            = empagemov.e81_codage
                                 inner join empagedadosretmov on empagedadosretmov.e76_codmov = empagemov.e81_codmov
                                 inner join empagedadosret    on empagedadosret.e75_codret    = empagedadosretmov.e76_codret
                                                             and empagedadosret.e75_codgera   = empagegera.e87_codgera                                 
                                 inner join empageconfgera    on empageconfgera.e90_codmov    = empagemov.e81_codmov
                                                             and empageconfgera.e90_codgera   = empagegera.e87_codgera 
                                  left join empord            on empord.e82_codmov            = empagemov.e81_codmov 
                                  left join pagordemele       on pagordemele.e53_codord       = empord.e82_codord
                                  left join corempagemov      on corempagemov.k12_codmov      = empagemov.e81_codmov 
                                  left join empageslip        on empageslip.e89_codmov        = empagemov.e81_codmov 
                                  left join slip              on slip.k17_codigo              = empageslip.e89_codigo 
                           where e90_correto ='t' 
                             and ( ((e53_valor-e53_vlranu-e53_vlrpag) > 0) or (slip.k17_situacao = 1 and slip.k17_instit = 1) )
                             and empageconfgera.e90_cancelado is false 
                             and corempagemov.k12_codmov is null)";
                             
}

if (isset($gerado) && $gerado == '0') {
  $where .= " and e87_codgera not in (select codgera from plugins.arquivoobngerado) ";
} else if (isset($gerado) && $gerado == '1') {
  $where .= " and e87_codgera in (select codgera from plugins.arquivoobngerado) ";
}
        ]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[require_once("classes/db_empagegera_classe.php");]]></search>
      <add position="replace">
        <![CDATA[require_once(modification("classes/db_empagegera_classe.php"));]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[$campos = "empagegera.*";]]></search>
      <add position="replace">
        <![CDATA[
$campos = "empagegera.*, empage.e80_instit as dl_Instituicao";]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[$where = " e91_codcheque is null and e80_instit = " . db_getsession("DB_instit");]]></search>
      <add position="replace">
        <![CDATA[
$where = " e91_codcheque is null ";]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[include("funcoes/db_func_empagegera.php");]]></search>
      <add position="replace">
        <![CDATA[
include(modification("funcoes/db_func_empagegera.php"));]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[$where  .= " and e90_cancelado is {$sVerificarCancelado} ";]]></search>
      <add position="replace">
        <![CDATA[$where  .= " and (e90_cancelado is {$sVerificarCancelado} or e87_codgera in (select e75_codgera from empagedadosret))";]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[$where .= " and empagedadosret.e75_codgera is not null ";]]></search>
      <add position="replace">
        <![CDATA[$where .= " and (empagedadosret.e75_codgera is not null or e87_codgera in (select e75_codgera from empagedadosret)) ";]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[$where .= " and empagedadosret.e75_codgera is not null ";]]></search>
      <add position="replace">
        <![CDATA[$where .= " and (empagedadosret.e75_codgera is not null or e87_codgera in (select e75_codgera from empagedadosret)) ";]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[if ($pesquisa_chave!=null && $pesquisa_chave!="") {

    if (isset($lRetorno) && $lRetorno == '1') {

      $where .= " and empagedadosret.e75_codgera is not null ";
    }]]></search>
      <add position="replace">
        <![CDATA[if ($pesquisa_chave!=null && $pesquisa_chave!="") {

    if (isset($lRetorno) && $lRetorno == '1') {

      $where .= " and (empagedadosret.e75_codgera is not null or exists (select 1 from empagedadosret inner join empagegera on e75_codgera = e87_codgera where e75_codgera = $pesquisa_chave)) ";
    }]]>
      </add>
    </operation>
  </file>

  <file path='classes/db_empagegera_classe.php'>
    <operation>
      <search><![CDATA[     $sql .= " from empagegera                                                                     ";
     $sql2 = "";
     $sql .= " inner join empageconfgera                                                           ";
     $sql .= "       on empageconfgera.e90_codgera = empagegera.e87_codgera                        ";
     $sql .= " inner join empageconf                                                               ";
     $sql .= "       on empageconf.e86_codmov = empageconfgera.e90_codmov                          ";
     $sql .= " inner join empagemov                                                                ";
     $sql .= "       on empagemov.e81_codmov = empageconfgera.e90_codmov                           ";
     $sql .= " inner join empage  on  empage.e80_codage = empagemov.e81_codage                     ";
     $sql .= " left join empempenho                                                                ";
     $sql .= "       on empempenho.e60_numemp = empagemov.e81_numemp                               ";
     $sql .= " left join cgm                                                                       ";
     $sql .= "      on cgm.z01_numcgm = empempenho.e60_numcgm                                      ";
		 $sql .= " left join empageconfche                                                             ";
		 $sql .= "      on empageconfche.e91_codmov = empagemov.e81_codmov and e91_ativo is true       ";
		 $sql .= " left join empagedadosret on empageconfgera.e90_codgera = empagedadosret.e75_codgera ";]]></search>
      <add position="replace">
        <![CDATA[     $sql .= " from empagegera                                                                     ";
     $sql2 = "";
     $sql .= " left join empageconfgera                                                           ";
     $sql .= "       on empageconfgera.e90_codgera = empagegera.e87_codgera                        ";
     $sql .= " left join empageconf                                                               ";
     $sql .= "       on empageconf.e86_codmov = empageconfgera.e90_codmov                          ";
     $sql .= " left join empagemov                                                                ";
     $sql .= "       on empagemov.e81_codmov = empageconfgera.e90_codmov                           ";
     $sql .= " left join empage  on  empage.e80_codage = empagemov.e81_codage                     ";
     $sql .= " left join empempenho                                                                ";
     $sql .= "       on empempenho.e60_numemp = empagemov.e81_numemp                               ";
     $sql .= " left join cgm                                                                       ";
     $sql .= "      on cgm.z01_numcgm = empempenho.e60_numcgm                                      ";
		 $sql .= " left join empageconfche                                                             ";
		 $sql .= "      on empageconfche.e91_codmov = empagemov.e81_codmov and e91_ativo is true       ";
		 $sql .= " left join empagedadosret on empageconfgera.e90_codgera = empagedadosret.e75_codgera ";]]>
      </add>
    </operation>
  </file>

  <file path='funcoes/db_func_empagegera.php'>
    <operation>
      <search><![CDATA[$campos = "empagegera.e87_codgera,empagegera.e87_descgera,empagegera.e87_data,empagegera.e87_hora,empagegera.e87_dataproc";]]></search>
      <add position="replace">
        <![CDATA[
$campos = "empagegera.e87_codgera, 
           (case 
              when (empage.e80_instit is not null) then empage.e80_instit ||' - '|| (select nomeinst from db_config where codigo = empage.e80_instit)
              else '' 
            end) as dl_Instituicao,
           empagegera.e87_descgera,
           empagegera.e87_data,
           empagegera.e87_hora,
           empagegera.e87_dataproc, 
           (case 
              when (empagegera.e87_codgera is not null) then 'R$ ' || (select sum(e81_valor) from empagemov inner join empageconfgera on e81_codmov = e90_codmov where e90_codgera = empagegera.e87_codgera group by e90_codgera)
              else ''
            end) as dl_Valor";]]>
      </add>
    </operation>
  </file>
  
  <file path='emp4_selarquivo001.php'>
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN] */]]></search>
      <add position="after">
        <![CDATA[
require_once("emp4_pluginGeracaoArquivoOBNArquivosProcessados001.php");
exit;
        ]]>
      </add>
    </operation>
  </file>  
  
  <file path='model/caixa/arquivos/PagamentoFornecedorBancoDoBrasilOBN.model.php'>
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - correcao codigo movimento] */          
          $oRegistro->codigo_movimento = trim((int) $oArquivo->nummov);]]></search>
      <add position="replace">
        <![CDATA[
        /* [Inicio plugin GeracaoArquivoOBN  - correcao codigo movimento] */
          $oRegistro->codigo_movimento = trim((int) $oArquivo->numob);
        ]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Observacao ocorrencia] */]]></search>
      <add position="after">
        <![CDATA[
           $oRegistro->observacao    = $oArquivo->observacaoob;
        ]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[$oRegistro->data_efetivacao  = date('Y-m-d');]]></search>
      <add position="replace">
        <![CDATA[$oRegistro->data_efetivacao  = substr($oArquivo->datamov, 4, 4)."-".substr($oArquivo->datamov, 2, 2)."-".substr($oArquivo->datamov, 0, 2);]]>
      </add>
    </operation>
    
  </file>
  
  <file path='model/caixa/arquivos/ProcessamentoPagamentoFornecedor.model.php'>
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN - processamento arquivo - parte1] */]]></search>
      <add position="after">
        <![CDATA[
      $oDaoEmpAgeDadosRetArquivo = db_utils::getDao("empagedadosretarquivo");
      $oDaoEmpAgeDadosRetArquivo->empagedadosret = $oDaoEmpAgeDadosRet->e75_codret; 
      $oDaoEmpAgeDadosRetArquivo->usuario = db_getsession("DB_id_usuario");
      $oDaoEmpAgeDadosRetArquivo->data = date("Y-m-d");
      $oDaoEmpAgeDadosRetArquivo->arquivo = substr($this->sCaminhoArquivo, (strripos($this->sCaminhoArquivo, "/")+1)) ;
      $oDaoEmpAgeDadosRetArquivo->incluir();
      if ($oDaoEmpAgeDadosRetArquivo->erro_status == "0") {
         throw new BusinessException("[Erro 3.0] Não foi possível salvar o nome do arquivo processado. - {$oDaoEmpAgeDadosRetArquivo->erro_msg}");
      } 
       ]]>
      </add>
    </operation>
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN - processamento arquivo - parte2] */
    if (count($aMovimentosNaoRetornados) > 0) {]]></search>
      <add position="replace">
        <![CDATA[
    /* [Inicio plugin GeracaoArquivoOBN  - processamento arquivo - parte2] */
    if (count($aMovimentosNaoRetornados) > 0 && $this->iCodigoBancoProcessar != "000") {    
       ]]>
      </add>
    </operation>
    <operation>        
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN - processamento arquivo - parte3] */]]></search>
      <add position="after">
        <![CDATA[
          if (trim($this->oRegistroArquivo->registros[0]->observacao) != "") {
            $oDaoEmpAgeDadosRetMovOcorrenciaObservacao = db_utils::getDao("empagedadosretmovocorrenciaobservacao");
            $oDaoEmpAgeDadosRetMovOcorrenciaObservacao->empagedadosretmovocorrencia = $oDaoEmpAgeDadosRetMovOcorrencia->e02_sequencial; 
            $oDaoEmpAgeDadosRetMovOcorrenciaObservacao->observacao = $this->oRegistroArquivo->registros[0]->observacao;
            $oDaoEmpAgeDadosRetMovOcorrenciaObservacao->incluir();
            if ($oDaoEmpAgeDadosRetMovOcorrencia->erro_status == "0") {
                throw new BusinessException("[Erro 3.1] Não foi possível salvar a ocorrência para o movimento {$iCodigoMovimentoNaoRetornado}. - {$oDaoEmpAgeDadosRetMovOcorrenciaObservacao->erro_msg}");
            }
          }
        ]]>
      </add>
    </operation>
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN - processamento arquivo - parte4] */]]></search>
      <add position="after">
        <![CDATA[
      if (trim($oMovimentoRetorno->observacao) != "") {
        $oDaoEmpAgeDadosRetMovOcorrenciaObservacao = db_utils::getDao("empagedadosretmovocorrenciaobservacao");
        $oDaoEmpAgeDadosRetMovOcorrenciaObservacao->empagedadosretmovocorrencia = $oDaoEmpAgeDadosRetMovOcorrencia->e02_sequencial;
        $oDaoEmpAgeDadosRetMovOcorrenciaObservacao->observacao = "{$oMovimentoRetorno->observacao}";
        $oDaoEmpAgeDadosRetMovOcorrenciaObservacao->incluir();
        if ($oDaoEmpAgeDadosRetMovOcorrenciaObservacao->erro_status == "0") {
          throw new BusinessException("[Erro 6.1] Não foi possível salvar a ocorrência para o movimento {$iCodigoMovimento} - $oDaoEmpAgeDadosRetMovOcorrenciaObservacao->erro_msg");
        }
      }
        ]]>
      </add>
    </operation>         
  </file>
  
  <file path='emp2_gerarq002.php'>
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - relatorio arquivos gerados] */]]></search>
      <add position="after">
        <![CDATA[
require_once("emp2_pluginGeracaoArquivoOBNRelatorioArquivosGerados002.php");
exit;
        ]]>
      </add>
    </operation>
    <operation>
      <search><![CDATA[	  pc63_dataconf,
	  e60_codemp,]]></search>
      <add position="after">
        <![CDATA[
	(case when empagemovtipotransmissaofatura.fatura = 't' then 2 else 1 end) as comfatura,]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[	  left join pcfornecon on pc63_contabanco = e98_contabanco
	  left join cgm on z01_numcgm = pc63_numcgm]]></search>
      <add position="after">
        <![CDATA[
	left join plugins.empagemovtipotransmissaofatura on e25_sequencial = empagemovtipotransmissaofatura.empagemovtipotransmissao]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[	  pc63_dataconf,
	  'slip' as e60_codemp,]]></search>
      <add position="after">
        <![CDATA[
	(case when empagemovtipotransmissaofatura.fatura = 't' then 2 else 1 end) as comfatura,]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[       left join conplano concre           on concre.c60_codcon  = cre.c61_codcon
                                          and concre.c60_anousu  = cre.c61_anousu

       left join conplanoconta descrconta  on concre.c60_codcon  = descrconta.c63_codcon
                                          and concre.c60_anousu  = descrconta.c63_anousu]]></search>
      <add position="after">
        <![CDATA[
	left join plugins.empagemovtipotransmissaofatura on e25_sequencial = empagemovtipotransmissaofatura.empagemovtipotransmissao]]>
      </add>
    </operation>
  </file>
  
  <file path='emp4_inconsistenciaarquivoretorno002.php'>
    <operation>
      <search><![CDATA[$oDaoEmpAgeDadosRet = new cl_empagedadosret();]]></search>
      <add position="replace">
        <![CDATA[$oDaoEmpAgeDadosRet = db_utils::getDao("empagedadosretmovocorrenciaobservacao");]]>
      </add>
    </operation>
    <operation>
      <search><![CDATA[$sSqlCampos .= " e92_coderro ||' - '||e92_descrerro as erro_banco ";]]></search>
      <add position="replace">
        <![CDATA[$sSqlCampos       .= " e92_coderro ||' - '||e92_descrerro||' - '||observacao as erro_banco ";]]>
      </add>
    </operation>
    <operation>
      <search><![CDATA[$aWidth   = array( 20, 20, 20, 25, 30, 70 );]]></search>
      <add position="replace">
        <![CDATA[$aWidth   = array( 20, 20, 20, 25, 30, 160 );]]>
      </add>
    </operation>
  </file>
  
  /**
   * FATURA
   */
  <file path='emp4_configuracaoarquivoenvio001.php'>
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao arquivo OBN - parte0] */]]></search>
      <add position="after">
        <![CDATA[
                var faturaAnexo = (oDado.fatura == "t") ? "Sim" : "Não";
        ]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao arquivo OBN - parte1] */
                aRow[6] = "<input type='button' value='Editar' onclick='js_criaJanelaDetalhes("+oDado.e81_codmov+", "+oDado.o15_codigo+");'  ";]]></search>
      <add position="replace">
        <![CDATA[
               /* [Inicio plugin GeracaoArquivoOBN  - Geracao arquivo OBN - parte1] */
                aRow[6] = (oDado.fatura == "t") ? "Sim" : "Não";
                aRow[7] = "<input type='button' value='Editar' onclick='js_criaJanelaDetalhes("+oDado.e81_codmov+", "+oDado.o15_codigo+");'  ";
        ]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao arquivo OBN - parte2] */
              aRow[6] = "<input type='button' value='Editar' onclick='js_criaJanelaDetalhes("+oDado.e81_codmov+", "+oDado.c61_codigo+");'  ";]]></search>
      <add position="replace">
        <![CDATA[
             /* [Inicio plugin GeracaoArquivoOBN  - Geracao arquivo OBN - parte2] */
              aRow[6] = (oDado.fatura == "t") ? "Sim" : "Não";
              aRow[7] = "<input type='button' value='Editar' onclick='js_criaJanelaDetalhes("+oDado.e81_codmov+", "+oDado.c61_codigo+");'  ";
         
              aValoresMovimentos[oDado.e81_codmov] = oDado.k17_valor;
        ]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao arquivo OBN - parte3] */]]></search>
      <add position="after">
        <![CDATA[
              oParametros.fatura        = $F('iFatura');
        ]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[  /* [Inicio plugin GeracaoArquivoOBN  - Geracao arquivo OBN - parte4] */
  oGridConfiguracao.setCellWidth(new Array( '100px' ,
                                            '100px',
                                            '100px',
                                            '200px',
                                            '200px',
                                            '100px',
                                            '80px'
                                           ));
  oGridConfiguracao.setCellAlign(new Array( 'left'  ,
                                            'left'  ,
                                            'left',
                                            'left',
                                            'left',
                                            'right',
                                            'center'
                                           ));
  oGridConfiguracao.setHeader(new Array( 'Cód.Mov',
                                         'Emp. / Slip',
                                         'Recurso',
                                         'Cta. Pagadora',
                                         'Nome',
                                         'Valor',
                                         'Ação'
                                        ));]]></search>
      <add position="replace">
        <![CDATA[
         /* [Inicio plugin GeracaoArquivoOBN  - Geracao arquivo OBN - parte4] */
         oGridConfiguracao.setCellWidth(new Array( '100px' ,
                                                   '100px',
                                                   '100px',
                                                   '200px',
                                                   '200px',
                                                   '100px',
                                                   '100px',
                                                   '80px'
                                                  ));
         oGridConfiguracao.setCellAlign(new Array( 'left'  ,
                                                   'left'  ,
                                                   'left',
                                                   'left',
                                                   'left',
                                                   'right',
                                                   'center',
                                                   'center'
                                                  ));
         oGridConfiguracao.setHeader(new Array( 'Cód.Mov',
                                                'Emp. / Slip',
                                                'Recurso',
                                                'Cta. Pagadora',
                                                'Nome',
                                                'Valor',
                                                'Fatura Anexo',
                                                'Ação'
                                               ));
        ]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao arquivo OBN - parte5] */]]></search>
      <add position="after">
        <![CDATA[
      sConteudoDetalhes += "      <tr nowrap>     ";
      sConteudoDetalhes += "        <td >   ";
      sConteudoDetalhes += "         <strong> Com Fatura Anexo? </strong>  ";
      sConteudoDetalhes += "        </td>  ";
      sConteudoDetalhes += "        <td align='left'>   ";
      sConteudoDetalhes += "           <select id='iFatura' name='iFatura' style='width:100px;' >";
      sConteudoDetalhes += "             <option value='f'>Não</option>           ";
      sConteudoDetalhes += "             <option value='t'>Sim</option>         ";
      sConteudoDetalhes += "           </select>";
      sConteudoDetalhes += "        </td>  ";
      sConteudoDetalhes += "      </tr>    ";
        ]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao arquivo OBN - parte6] */]]></search>
      <add position="after">
        <![CDATA[
                          $('iFatura').disabled           = true;
        ]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao arquivo OBN - parte7] */]]></search>
      <add position="after">
        <![CDATA[
                          $('iFatura').disabled           = false;
        ]]>
      </add>
    </operation>
    
  </file>
  
  <file path='emp4_configuracaoarquivoenvio.RPC.php'>
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN] */]]></search>
      <add position="after">
        <![CDATA[
                $oDaoEmpAgeMovTipoTransmissaoFatura = db_utils::getDao("empagemovtipotransmissaofatura");
                $oDaoEmpAgeMovTipoTransmissaoFatura->empagemovtipotransmissao  = $oDadosEmpAgeMovTipoTransmissao->e25_sequencial;
                $oDaoEmpAgeMovTipoTransmissaoFatura->fatura                    = "{$oParam->fatura}";
                $rsEmpAgeMovTipoTransmissaoFatura = $oDaoEmpAgeMovTipoTransmissaoFatura->sql_record($oDaoEmpAgeMovTipoTransmissaoFatura->sql_query_file(null, "*", null, "empagemovtipotransmissao = {$oDadosEmpAgeMovTipoTransmissao->e25_sequencial}"));
                if ($oDaoEmpAgeMovTipoTransmissaoFatura->numrows == 0) {
                     
                    $oDaoEmpAgeMovTipoTransmissaoFatura->sequencial = null;
                    $oDaoEmpAgeMovTipoTransmissaoFatura->incluir();
                     
                } else {
                     
                    $oDadosEmpAgeMovTipoTransmissao->e25_sequencial = db_utils::fieldsMemory($rsEmpAgeMovTipoTransmissaoFatura,0)->sequencial;
                    $oDaoEmpAgeMovTipoTransmissaoFatura->alterar($oDadosEmpAgeMovTipoTransmissao->e25_sequencial);
                     
                }
                if ($oDaoEmpAgeMovTipoTransmissaoFatura->erro_status == 0) {
                    throw new DBException("ERRO [ 1 ] - Alterando informacao de fatura para o Movimento " . $oDaoEmpAgeMovTipoTransmissaoFatura->erro_msg);
                }
        ]]>
      </add>
    </operation>
  </file>
    
  <file path='model/agendaPagamento.model.php'>
    <operation>
      <search><![CDATA[(select e25_empagetipotransmissao from empagemovtipotransmissao where e25_empagemov = e81_codmov limit 1) as e25_empagetipotransmissao,]]></search>
      <add position="after">
        <![CDATA[
      (select fatura 
         from plugins.empagemovtipotransmissaofatura 
              inner join empagemovtipotransmissao on empagemovtipotransmissao = e25_sequencial 
        where e25_empagemov = e81_codmov 
        limit 1) as fatura,]]>
      </add>
    </operation>
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte1] */]]></search>
      <add position="after">
        <![CDATA[
    $sCampos  .= "(select fatura                                ";
    $sCampos  .= "  from plugins.empagemovtipotransmissaofatura ";
    $sCampos  .= "       inner join empagemovtipotransmissao on empagemovtipotransmissao = e25_sequencial ";
    $sCampos  .= " where e25_empagemov = e81_codmov             ";
    $sCampos  .= " limit 1 ) as fatura,                        ";]]>
      </add>
    </operation>    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte2] */    
    $sCampos  .= " e98_contabanco as conta_configurada,                   ";]]></search>
      <add position="replace">
        <![CDATA[
    /* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte2] */    
    $sCampos  .= "(select pc.pc63_contabanco                ";
    $sCampos  .= " from  conplanoconta                   ";
    $sCampos  .= "       inner join pcfornecon pc on pc.pc63_banco = c63_banco and pc.pc63_agencia = c63_agencia ";
    $sCampos  .= "                  and pc.pc63_conta = c63_conta and pc.pc63_conta_dig = c63_dvconta            ";                        
    $sCampos  .= "                  and pc.pc63_agencia_dig = c63_dvagencia                                      "; 
    $sCampos  .= " where c63_codcon = x.c61_codcon and c63_anousu = x.c61_anousu and pc.pc63_numcgm = z01_numcgm ";             
    $sCampos  .= "  limit 1) as conta_configurada,                                                               ";]]>
      </add>
    </operation>
  </file>   
  
  <file path='model/caixa/ConfiguracaoArquivoObn.model.php'>
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao arquivo OBN - parte1] */]]></search>
      <add position="after">
        <![CDATA[
  const OPERACAO_SLIP_CONTAUNICA    = 17;
  const OPERACAO_COM_FATURA    = 33;
  const OPERACAO_SLIP_OUTRASCONTAS  = 37;
        ]]>
      </add>
    </operation>
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao arquivo OBN - parte2] */]]></search>
      <add position="after">
        <![CDATA[
    // Se o Movimento estiver marcado como fatura (Sim = t) então tipo = 33
    if ($oDadosMovimentacao->getComFatura() == "t") {
       return ConfiguracaoArquivoObn::OPERACAO_COM_FATURA;
    }

    if ($oDadosMovimentacao->getSlipVinculo() == 13) {
      if ($oDadosMovimentacao->getCodigoBancoFavorecido() == $oDadosMovimentacao->getCodigoBancoPagador()) { 
        return ConfiguracaoArquivoObn::OPERACAO_DEP;
      } else { // Banco Diferente
          return ConfiguracaoArquivoObn::OPERACAO_DOC;
      }
    }
        ]]>
      </add>
    </operation>
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao arquivo OBN - parte3] */]]></search>
      <add position="after">
        <![CDATA[
      if ($oDadosMovimentacao->getCodigoSlip() != null) {
        if ($oDadosMovimentacao->getContaPagadora().$oDadosMovimentacao->getDigitoVerificadorContaPagadora() == "70009"){
          return ConfiguracaoArquivoObn::OPERACAO_SLIP_CONTAUNICA;
        } else {
         return ConfiguracaoArquivoObn::OPERACAO_SLIP_OUTRASCONTAS;
        }
      }


      // se for Slip e a conta pagadora 7000-9 tipo 17, caso contrario tipo 37
      if ($oDadosMovimentacao->getCodigoSlip() != null) {
        if ($oDadosMovimentacao->getContaPagadora().$oDadosMovimentacao->getDigitoVerificadorContaPagadora() == "70009"){
          return ConfiguracaoArquivoObn::OPERACAO_SLIP_CONTAUNICA;
        } else {
          return ConfiguracaoArquivoObn::OPERACAO_SLIP_OUTRASCONTAS;
        }
      }]]>
      </add>
    </operation>
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao arquivo OBN - parte4] */]]></search>
      <add position="after">
        <![CDATA[
    else { // Banco Diferente
      return ConfiguracaoArquivoObn::OPERACAO_DOC;
    }
        ]]>
      </add>
    </operation>
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao arquivo OBN - parte5] */]]></search>
      <add position="after">
        <![CDATA[
  /**
   * Função que verifica o layout em que a linha será gerada
   * Caso não exista cadastro de detalhe (código de barras) será o LAYOUT3
   * Senão tipo LAYOUT4
   * @return Integer
   */
  public static function verificaTipoLinha_2($sCodigoDeBarras, $iSlip, $iCodigoBancoFavorecido, $iSlipVinculo) {
    if (!empty($sCodigoDeBarras)) {
        return ConfiguracaoArquivoObn::LAYOUT4;
    }

    // caso seja slip
    if ($iSlip != null){

    if ($iCodigoBancoFavorecido == '001') {
        if ($iSlipVinculo == 13) { // Slip de Retenção
            return ConfiguracaoArquivoObn::LAYOUT2;
        } else {
            return ConfiguracaoArquivoObn::LAYOUT3;
        }
    } else {
       return ConfiguracaoArquivoObn::LAYOUT2;
    }

    } else {
    return ConfiguracaoArquivoObn::LAYOUT2;
    }

    if (empty($sCodigoDeBarras)){
      return ConfiguracaoArquivoObn::LAYOUT2;
    }
    return 0;
  }
        ]]>
      </add>
    </operation>
  </file>
    
  <file path='model/caixa/MovimentoArquivoTransmissao.model.php'>
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - processamento arquivo OBN - parte1] */]]></search>
      <add position="after">
        <![CDATA[
  /**
   * Orgao
   * @var Integer
   */
  private $sOrgao;
  
  /**
   * Unidade 
   * @var Integer
   */
  private $iUnidade;  
  
  /**
   * Codigo com ou sem fatura (f - Não, t - Sim)
   * @var integer
   */
  private $iComFatura;
        ]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - processamento arquivo OBN - parte2] */]]></search>
      <add position="after">
        <![CDATA[
  /**
   * Slip Vinculo 
   * @var integer
   */
  private $iSlipVinculo;

  public function getOrgao() {
      return $this->sOrgao;
  }

  public function setOrgao($sOrgao) {
      $this->sOrgao = $sOrgao;
  }

  public function getUnidade() {
      return $this->iUnidade;
  }

  public function setUnidade($iUnidade) {
      $this->iUnidade = $iUnidade;
  }

  public function getComFatura() {
    return $this->iComFatura;
  }

  public function setComFatura($iComFatura) {
    $this->iComFatura = $iComFatura;
  }

  public function setSlipVinculo($iSlipVinculo) {
    $this->iSlipVinculo = $iSlipVinculo;
  }

  public function getSlipVinculo() {
    return $this->iSlipVinculo;
  }
        ]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - processamento arquivo OBN - parte3] */]]></search>
      <add position="after">
        <![CDATA[
    $oDadosLinha->setOrgao($oStdResultadoQuery->orgao);
    $oDadosLinha->setUnidade($oStdResultadoQuery->unidade);
    $oDadosLinha->setComFatura($oStdResultadoQuery->comfatura);
    $oDadosLinha->setSlipVinculo($oStdResultadoQuery->slipvinculo);
        ]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - processamento arquivo OBN - parte4] */]]></search>
      <add position="after">
        <![CDATA[
         $oDaoPluginGeracaoArquivoOBN = db_utils::getDao("PluginGeracaoArquivoOBN");
         return $oDaoPluginGeracaoArquivoOBN->getSqlDadosMovimentacao($sCodigoGeracao, $iInstituicao, $iAno, $iCodigoMovimento);
         
         /*****
          *
          * Atencao:
          * Codigo abaixo nao eh utilizado quando o plugin esta ativo!
          * Para ver o sql ou mesmo aterar, deve ser visto o arquivo classes/db_PluginGeracaoArquivoOBN_classe.php
          *
          */
        ]]>
      </add>
    </operation>
  </file>

  <file path='model/caixa/GeradorArquivoOBN.model.php'>
  
    <operation>
      <search><![CDATA[require_once ("model/caixa/ConfiguracaoArquivoObn.model.php");]]></search>
      <add position="replace">
        <![CDATA[require_once (modification("model/caixa/ConfiguracaoArquivoObn.model.php"));]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte2] */
      $oLinha          = $this->constroiLinhaTipoDois($oDadosMovimento);
      $oLayoutTXT->setByLineOfDBUtils($oLinha, 3, 2);]]></search>
      <add position="replace">
        <![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte2] */
      //$oLinha          = $this->constroiLinhaTipoDois($oDadosMovimento);
      //$oLayoutTXT->setByLineOfDBUtils($oLinha, 3, 2);]]>
      </add>
    </operation>  
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte3] */
      $iTipoLinha = ConfiguracaoArquivoObn::verificaTipoLinha($oDadosMovimento->getCodigoBarra());]]></search>
      <add position="replace">
        <![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte3] */
       $iTipoLinha      = ConfiguracaoArquivoObn::verificaTipoLinha_2($oDadosMovimento->getCodigoBarra(), 
                                                                      $oDadosMovimento->getCodigoSlip(), 
                                                                      $oDadosMovimento->getCodigoBancoFavorecido(), 
                                                                      $oDadosMovimento->getSlipVinculo());]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte4] */]]></search>
      <add position="after">
        <![CDATA[
        case ConfiguracaoArquivoObn::LAYOUT2:
          $oLinha          = $this->constroiLinhaTipoDois($oDadosMovimento);
          $oLayoutTXT->setByLineOfDBUtils($oLinha, 3, 2);
        break;
        case ConfiguracaoArquivoObn::LAYOUT3:
          /*
            O tipo 3 é utilizado em Natal para os Slips. O banco configurou este tipo 3 e tipo de operação 17 em Natal para float 0,
            ou seja, uma transferência para o entre secretárias é realizada no mesmo dia.
            E o tipo de operação nela contida é 17, caso a conta crédito seja a conta única (7000-9) e 37 para as demais contas.
          */
          
          $oLinha          = $this->constroiLinhaTipoDois($oDadosMovimento);
          $oLayoutTXT->setByLineOfDBUtils($oLinha, 3, 2); 
            
          $this->iSequencialRegistro++;
          $this->iContadorRegistros++;
          $aCodigoSequenciais[] = $this->iContadorRegistros;

          $oLinha          = $this->constroiLinhaTipoTresNovo($oDadosMovimento);
          $oLayoutTXT->setByLineOfDBUtils($oLinha, 3, 3);
        break;
        ]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte5] */]]></search>
      <add position="after">
        <![CDATA[
          $oLinha          = $this->constroiLinhaTipoDois($oDadosMovimento);
          $oLayoutTXT->setByLineOfDBUtils($oLinha, 3, 2);
        ]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte6] */]]></search>
      <add position="after">
        <![CDATA[
        default:
          throw new BusinessException("Linha $iTipo não foi configurada para tipo OBN.");
        ]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte7] */
      $sCPFCNPJ = str_pad($sCPFCNPJ, 14, "0", STR_PAD_RIGHT);]]></search>
      <add position="replace">
        <![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte7] */
      $sCPFCNPJ = str_pad($sCPFCNPJ, 14, " ", STR_PAD_RIGHT);]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte8] */
    $oStdLinhaTipoDois->codigo_retorno = str_repeat(" ", 2);]]></search>
      <add position="replace">
        <![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte8] */
    $oStdLinhaTipoDois->codigo_retorno                = str_repeat("0", 2);]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte9] */
    $oStdLinhaTipoDois->finalidade_pagamento = str_pad($sCodigoFinalidadePagamento, 3, "0", STR_PAD_LEFT);
    $oStdLinhaTipoDois->prefixo_conta_convenio = str_pad($sContaDigitoPagadora, 10, "0", STR_PAD_LEFT);]]></search>
      <add position="replace">
        <![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte9] */
    $oStdLinhaTipoDois->finalidade_pagamento        = str_repeat(" ", 3);
    $oStdLinhaTipoDois->prefixo_conta_convenio        = str_pad($sContaDigitoPagadora, 10, " ", STR_PAD_RIGHT);]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte10] */
    $oStdLinhaTipoDois->campo_um = "1";]]></search>
      <add position="replace">
        <![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte10] */
    $oStdLinhaTipoDois->campo_um = "0";]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte11] */
    $oStdLinhaTipoDois->codigo_movimentacao = str_pad($oDadosLinha->getCodigoMovimento(), 11, "0", STR_PAD_LEFT);]]></search>
      <add position="replace">
        <![CDATA[    /* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte11] */
    $oStdLinhaTipoDois->codigo_movimentacao = str_pad(number_format($oDadosLinha->getCodigoArquivoSistema(),0,',','.')."/".db_getsession("DB_anousu"), 11, "0", STR_PAD_LEFT);]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte12] */
    $oStdLinhaTipoDois->codigo_instituicao = ConfiguracaoArquivoObn::CODIGO_PADRAO_INSTITUICAO;]]></search>
      <add position="replace">
        <![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte12] */
    $sUgGestao      =  str_pad(str_pad($oDadosLinha->getOrgao(),2,"0",STR_PAD_LEFT).str_pad($oDadosLinha->getUnidade(),2,"0",STR_PAD_LEFT),"6","0",STR_PAD_LEFT).str_pad("1",5,"0",STR_PAD_LEFT);
    if ($oDadosLinha->getContaPagadora() == "7000") {
    $sUgGestao          =  "0".str_pad($oDadosLinha->getOrgao(),2,"0",STR_PAD_LEFT)."000".str_pad("1",5,"0",STR_PAD_LEFT);
    }
    $oStdLinhaTipoDois->codigo_instituicao      = $sUgGestao;]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte13] */]]></search>
      <add position="after">
        <![CDATA[
  /**
   * Constrói os dados que serão impressos na linha do tipo 3 (novo)
   * @param MovimentoArquivoTransmissao $oDadosLinha
   * @return stdClass
   */
  private function constroiLinhaTipoTresNovo(MovimentoArquivoTransmissao $oDadosLinha) {

    list($iAno, $iMes, $iDia) = explode("-", $this->dtGeracaoArquivo);
    $iTipoFavorecido          = ConfiguracaoArquivoObn::verificaTipoFavorecido(strlen($oDadosLinha->getCnpj()));
    $iTipoOperacao            = ConfiguracaoArquivoObn::verificarTipoOperacao($oDadosLinha);
    $iTipoPagamento           = ConfiguracaoArquivoObn::verificaTipoPagamento($iTipoOperacao);

    $sUgGestao          =  str_pad(str_pad($oDadosLinha->getOrgao(),2,"0",STR_PAD_LEFT).str_pad($oDadosLinha->getUnidade(),2,"0",STR_PAD_LEFT),"6","0",STR_PAD_LEFT).str_pad("1",5,"0",STR_PAD_LEFT);

    if ($oDadosLinha->getContaPagadora() == "7000") {        
    $sUgGestao          =  "0".str_pad($oDadosLinha->getOrgao(),2,"0",STR_PAD_LEFT)."000".str_pad("1",5,"0",STR_PAD_LEFT);
    }

    $sCPFCNPJ = $oDadosLinha->getCnpj();
    if ($iTipoFavorecido == ConfiguracaoArquivoObn::TIPO_CPF) {
      $sCPFCNPJ = str_pad($sCPFCNPJ, 14, " ", STR_PAD_RIGHT);
    }
   
    $sAgenciaInstituicao = $oDadosLinha->getCodigoAgenciaPagadora().$oDadosLinha->getDigitoVerificadorAgenciaPagadora();
    $sContaConvenio      = $oDadosLinha->getContaFavorecida().$oDadosLinha->getDigitoVerificadorContaFavorecida();

    $sAgenciaDigitoPagadora = str_pad(substr($oDadosLinha->getCodigoAgenciaPagadora(), -4), 4, "0", STR_PAD_LEFT).$oDadosLinha->getDigitoVerificadorAgenciaPagadora();
    $sContaDigitoPagadora   = $oDadosLinha->getContaPagadora().$oDadosLinha->getDigitoVerificadorContaPagadora();

    $sCodigoFinalidadePagamento = $oDadosLinha->getFinalidadePagamentoFundeb();
    if (!empty($sCodigoFinalidadePagamento)) {

      $oFinalidadePagamento       = new FinalidadePagamentoFundeb($oDadosLinha->getFinalidadePagamentoFundeb());
      $sCodigoFinalidadePagamento = $oFinalidadePagamento->getCodigo();
    }


    $sDigitoVerificadorAgenciaFavorecido = $oDadosLinha->getDigitoVerificadorAgenciaFavorecida();
    $sCodigoAgenciaFavorecido            = str_pad(substr($oDadosLinha->getCodigoAgenciaFavorecida(), -4), 4, "0", STR_PAD_LEFT);
    $sCodigoBancoFavorecido              = $oDadosLinha->getCodigoBancoFavorecido();
    $sContaDigitoFavorecido              = str_pad($oDadosLinha->getContaFavorecida().$oDadosLinha->getDigitoVerificadorContaFavorecida(), 10, "0", STR_PAD_LEFT);

    if ($oDadosLinha->getCodigoBarra() != "") {


      $sDigitoVerificadorAgenciaFavorecido = str_pad("0", 01, "0", STR_PAD_LEFT);
      $sCodigoAgenciaFavorecido            = str_pad("0", 04, "0", STR_PAD_LEFT);
      $sCodigoBancoFavorecido              = str_pad("0", 03, "0", STR_PAD_LEFT);
      $sContaDigitoFavorecido              = str_pad("0", 10, "0", STR_PAD_LEFT);
      
    }

    $oStdLinhaTipoTres                                  = new stdClass();
    $oStdLinhaTipoTres->numero_sequencial_movimento     = str_pad($this->iSequencialRegistro, 7, "0", STR_PAD_LEFT);
    $oStdLinhaTipoTres->codigo_operacao                 = $iTipoOperacao;
    $oStdLinhaTipoTres->campo_branco_quatro         = str_repeat(" ", 7);
    $oStdLinhaTipoTres->numero_conta_convenio       = str_pad($sContaDigitoPagadora, 10, " ", STR_PAD_RIGHT);
    $oStdLinhaTipoTres->prefixo_agencia         = $sAgenciaDigitoPagadora;
    $oStdLinhaTipoTres->codigo_favorecido           = $sCPFCNPJ;
    $oStdLinhaTipoTres->tipo_favorecido         = $iTipoFavorecido;
    $oStdLinhaTipoTres->campo_zero_tres         = "0";
    $oStdLinhaTipoTres->observacao                      = str_repeat(" ", 40);
    $oStdLinhaTipoTres->uf_favorecido               = $oDadosLinha->getUf();
    $oStdLinhaTipoTres->cep_favorecido          = $oDadosLinha->getCep();
    $oStdLinhaTipoTres->campo_branco_tres       = str_repeat(" ", 17);
    $oStdLinhaTipoTres->municipio_favorecido        = $oDadosLinha->getMunicipio();
    $oStdLinhaTipoTres->endereco_favorecido     = $oDadosLinha->getEndereco();
    $oStdLinhaTipoTres->nome_favorecido             = $oDadosLinha->getNome();
    $oStdLinhaTipoTres->codigo_contacorrente_bancaria_favorecido    = $sContaDigitoFavorecido;
    $oStdLinhaTipoTres->digito_verificador_agencia_favorecido       = $sDigitoVerificadorAgenciaFavorecido;
    $oStdLinhaTipoTres->codigo_agencia_banco_favorecido = $sCodigoAgenciaFavorecido;
    $oStdLinhaTipoTres->codigo_banco_favorecido     = $sCodigoBancoFavorecido;
    $oStdLinhaTipoTres->valor_liquido_movimentacao  = str_pad(str_replace(".", "", $oDadosLinha->getValor()), 17, "0", STR_PAD_LEFT);
    $oStdLinhaTipoTres->campo_branco_dois       = str_repeat(" ", 3);
    $oStdLinhaTipoTres->campo_zero_um           = "000001";             // Campo sequencial da Lista (Fixo 000001)
    $oStdLinhaTipoTres->tipo_pagamento          = "1";              // 1 - Pagamento Crédito em Conta BB
    $oStdLinhaTipoTres->codigo_operacao         = $iTipoOperacao;
    $oStdLinhaTipoTres->campo_branco_um         = str_repeat(" ", 4);
    $oStdLinhaTipoTres->data_movimentacao       = "{$iDia}{$iMes}{$iAno}";
    $oStdLinhaTipoTres->codigo_ob           = str_pad($oDadosLinha->getCodigoMovimento(), 11, "0", STR_PAD_LEFT);
    $oStdLinhaTipoTres->codigo_movimentacao     = str_pad(number_format($oDadosLinha->getCodigoArquivoSistema(),0,',','.')."/".db_getsession("DB_anousu"), 11, "0", STR_PAD_LEFT);
    $oStdLinhaTipoTres->codigo_instituicao      = $sUgGestao;
    $oStdLinhaTipoTres->codigo_agencia_bancaria_instituicao = $sAgenciaInstituicao;
    $oStdLinhaTipoTres->codigo_retorno_operacao     = str_repeat("0", 2);
    $oStdLinhaTipoTres->identificador_linha     = 3;
    return $oStdLinhaTipoTres;
  }  ]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte14] */
    $oStdLinhaTipoQuatro->codigo_instituicao = ConfiguracaoArquivoObn::CODIGO_PADRAO_INSTITUICAO;
    $oStdLinhaTipoQuatro->codigo_movimento = str_pad($oDadosLinha->getCodigoMovimento(), 11, "0", STR_PAD_LEFT);]]></search>
      <add position="replace">
        <![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte14] */
    $sUgGestao          =  str_pad(str_pad($oDadosLinha->getOrgao(),2,"0",STR_PAD_LEFT).str_pad($oDadosLinha->getUnidade(),2,"0",STR_PAD_LEFT),"6","0",STR_PAD_LEFT).str_pad("1",5,"0",STR_PAD_LEFT);
    if ($oDadosLinha->getContaPagadora() == "7000") {
        $sUgGestao          =  "0".str_pad($oDadosLinha->getOrgao(),2,"0",STR_PAD_LEFT)."000".str_pad("1",5,"0",STR_PAD_LEFT);
    }
    $oStdLinhaTipoQuatro->codigo_instituicao               = $sUgGestao;
    $oStdLinhaTipoQuatro->codigo_movimento                 = str_pad(number_format($oDadosLinha->getCodigoArquivoSistema(),0,',','.')."/".db_getsession("DB_anousu"), 11, "0", STR_PAD_LEFT);]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte15] */
    $oStdLinhaTipoQuatro->campo_zero_um = str_repeat("0", 6);]]></search>
      <add position="replace">
        <![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte15] */
    $oStdLinhaTipoQuatro->campo_zero_um                    = "000001";]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte16] */]]></search>
      <add position="after">
        <![CDATA[    
    if ($oDadosLinha->getTipoFatura() == 2) {
      $oDadosLinha->setTipoFatura(1);
    } else {
       $oDadosLinha->setTipoFatura(2);
    }]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte17] */
    if ($oDadosLinha->getTipoFatura() == 2) {]]></search>
      <add position="replace">
        <![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte17] */
    if ($oDadosLinha->getTipoFatura() == 1) {]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte18] */
    $oStdLinhaTipoQuatro->convenio_conta_dv                = str_pad($sConvenioConta, 10, "0", STR_PAD_LEFT);]]></search>
      <add position="replace">
        <![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte18] */
    $oStdLinhaTipoQuatro->convenio_conta_dv                = str_pad($sConvenioConta, 10, " ", STR_PAD_RIGHT);]]>
      </add>
    </operation>    
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte19] */
    $oStdLinhaTipoQuatro->retorno_operacao                 = str_repeat(" ", 2);]]></search>
      <add position="replace">
        <![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte19] */
    $oStdLinhaTipoQuatro->retorno_operacao                 = str_repeat("0", 2);]]>
      </add>
    </operation>  
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte20] */]]></search>
      <add position="after">
        <![CDATA[
  public function salvarGeracaoTxtArquivo() {
  
    if (empty($this->iCodigoRemessa)) {
        throw new BusinessException("ERRO [ 3 ] - Salvando geracao txt do arquivo - Não foi encontrado código da remessa.");
    }
    
    $oArquivoGerado           = db_utils::getDao("arquivoobngerado");
    
    $iCodGera = $this->iCodigoRemessa;
    
    $rsValidaGeracao = $oArquivoGerado->sql_record($oArquivoGerado->sql_query_file("", "*", null,"codgera = {$iCodGera}"));
    if ($oArquivoGerado->numrows == 0) {
      $oArquivoGerado->codgera  = $this->iCodigoRemessa;
      $oArquivoGerado->datagera = date('d/m/Y');
      $oArquivoGerado->incluir(null);
      if ($oArquivoGerado->erro_status == 0) {
        throw new BusinessException("Não foi possível gravar geração do arquivo.");
      }
    }
  
    return true;
  }]]>
      </add>
    </operation>
      
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte21] */
    $sCodigoAgenciaFavorecido            = $oDadosLinha->getCodigoAgenciaFavorecida();]]></search>
      <add position="replace">
        <![CDATA[
    /* [Inicio plugin GeracaoArquivoOBN  - Geracao Arquivo OBN - parte21] */
    $sCodigoAgenciaFavorecido            = str_pad(substr($oDadosLinha->getCodigoAgenciaFavorecida(), -4), 4, "0", STR_PAD_LEFT);]]>
      </add>
    </operation>
    
    <operaction>
      <search><![CDATA[$oStdLinhaTrailer->somatorio_valores             = str_pad(str_replace(".", "", $this->nValorTotalDasMovimentacoes), 17, "0", STR_PAD_LEFT);]]></search>
      <add position="replace">
        <![CDATA[$oStdLinhaTrailer->somatorio_valores             = str_pad(str_replace(".", "", number_format($this->nValorTotalDasMovimentacoes, 2, ".", "")), 17, "0", STR_PAD_LEFT);]]>
      </add>
    </operaction>
  </file>  
  
  <file path='emp4_empageconfgera001_ordem.php'>
  
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Filtros Emissao Arquivo OBN - parte1] */]]></search>
      <add position="after">
        <![CDATA[
        $dbWhereEmpenho = "";
        $dbWhereSlip = "";
        $oSlipDepartamento = db_utils::getDao("slipdepartamento");
        if (isset($filtroUnidade) && !empty($filtroUnidade)) {
            $aFiltroUnidade = explode(":",$filtroUnidade);
            
            $iOrgao   = $aFiltroUnidade[0]; 
            $iUnidade = $aFiltroUnidade[1];
            
          if(!empty($iOrgao) && !empty($iUnidade)) {
            $dbWhereEmpenho  = "and orcdotacao.o58_orgao = {$iOrgao} ";
            $dbWhereEmpenho .= "and orcdotacao.o58_unidade = {$iUnidade}";
            
            $dbWhereSlip  = "and db_departorg.db01_orgao = {$iOrgao} ";
            $dbWhereSlip .= "and db_departorg.db01_unidade = {$iUnidade}";
            if (isset($geraUnidade)) {
              $dbWhereSlip .= "and db_departorg.db01_coddepto = " .db_getsession("DB_coddepto");
            }
          }
          else{
        
            $dbWhereEmpenho = "";
            $dbWhereSlip = "";
          }
            
        }
        $aUnidades = array();
        ]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Filtros Emissao Arquivo OBN - parte2] */]]></search>
      <add position="after">
        <![CDATA[
        $oPluginGeracaoArquivoOBN = db_utils::getDao("PluginGeracaoArquivoOBN");
        $sWhereEmpenho = "{$dbwhere} {$dbWhereEmpenho} and {$sWhereOrdem}"; 
        $sWhereSlip = "{$dbwhere} {$dbWhereSlip}";
        $sSqlTxt = $oPluginGeracaoArquivoOBN->sql_buscaMovimentosGeracaoArquivoOBN($sWhereEmpenho, $sWhereSlip);
        ]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[$sChecked  = " checked ";]]></search>
      <add position="replace">
        <![CDATA[$sChecked  = "  ";]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Filtros Emissao Arquivo OBN - parte3] */]]></search>
      <add position="after">
        <![CDATA[
            /* verifica se a unidade não está contida na lista, e se sua movimentação é do tipo OBN */
            if (!in_array($unidade, $aUnidades) && $e25_empagetipotransmissao == 2) {
              $aUnidades[$orgao.":".$unidade] = str_replace("'","",$orgao.":".$unidade."|".urlencode($o41_descr));
            }
            asort($aUnidades);
        ]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[if ($comboboxCNPJ != $db83_identificador) {]]></search>
      <add position="replace">
        <![CDATA[if ($comboboxCNPJ != $db83_identificador && $comboboxCNPJ != '') {]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[<!-- [Inicio plugin GeracaoArquivoOBN  - Filtros Emissao Arquivo OBN - parte5] -->]]></search>
      <add position="after">
        <![CDATA[
        <input type="hidden" size = "50" name='unidades' value='<?php echo json_encode($aUnidades)?>'>
        <?
          $unidadesSession = db_getsession("geracao_txt_unidades", false);
        
          if(!isset($unidadesSession)) {
            db_putsession("geracao_txt_unidades", json_encode($aUnidades)); 
          }
        ?>
        ]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Filtros Emissao Arquivo OBN - parte6] */]]></search>
      <add position="after">
        <![CDATA[
          $codigopagamento = "-";
          if ($e60_codemp != 0) {
            $codigopagamento = "Pagamento de Empenho";
          } else {
            if ($tiposlip == 1) {
              $codigopagamento = "Transferência";
            } else if ($tiposlip == 2) {
              $codigopagamento = "Retenção";
            } else if ($tiposlip == 3) {
              $codigopagamento = "Transferência (Repasse)";
            } else {
              $codigopagamento = "-";
            }
          }
         ]]>
      </add>
    </operation>         
  </file>
  
  <file path='emp4_empageconfgera001.php'>
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Filtros Emissao Arquivo OBN] */]]></search>
      <add position="after">
        <![CDATA[
if (!isset($unidades)) {
  db_destroysession("geracao_txt_unidades");
}

if (isset($geraUnidade)) {
  $oDepartOrg = db_utils::getDao("db_departorg");
  $rsDepartOrg = $oDepartOrg->sql_record($oDepartOrg->sql_query_file(db_getsession("DB_coddepto"), db_getsession("DB_anousu")));
  $oDadosDepartOrg = db_utils::fieldsMemory($rsDepartOrg, 0);
  $filtroUnidade = $oDadosDepartOrg->db01_orgao.":".$oDadosDepartOrg->db01_unidade;
}
        ]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[include("forms/db_frmempageconfgera.php");]]></search>
      <add position="replace">
        <![CDATA[include(modification("forms/db_frmempageconfgera.php"));]]>
      </add>
    </operation>    
    
  </file>
  
  <file path='forms/db_frmempageconfgera.php'>
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Filtros Emissao Arquivo OBN - parte1] */]]></search>
      <add position="after">
        <![CDATA[
        $filtroTipoTransmissao = ParametroCaixa::getTipoTransmissaoPadrao();
        if (empty($filtroTipoTransmissao)) {
            $filtroTipoTransmissao = 1;
        }
        ]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Filtros Emissao Arquivo OBN - parte2] */]]></search>
      <add position="after">
        <![CDATA[
  var objAtualizar = document.getElementById("btnAtualizar");
  var objDesatualizar = document.getElementById("btnDesatualizar");
  objAtualizar.disabled = true;
  objDesatualizar.disabled = true;]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Filtros Emissao Arquivo OBN - parte3] */]]></search>
      <add position="after">
        <![CDATA[
    js_inicializarUnidades();]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Filtros Emissao Arquivo OBN - parte4] */]]></search>
      <add position="after">
        <![CDATA[
        js_inicializarUnidades();]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Filtros Emissao Arquivo OBN - parte5] */]]></search>
      <add position="after">
        <![CDATA[
     js_inicializarUnidades();]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Filtros Emissao Arquivo OBN - parte6] */]]></search>
      <add position="after">
        <![CDATA[
     js_inicializarUnidades();]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Filtros Emissao Arquivo OBN - parte7] */]]></search>
      <add position="after">
        <![CDATA[
     js_inicializarUnidades();]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Filtros Emissao Arquivo OBN - parte8] */]]></search>
      <add position="after">
        <![CDATA[
     js_inicializarUnidades();]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[<!-- [Inicio plugin GeracaoArquivoOBN  - Filtros Emissao Arquivo OBN - parte9] -->]]></search>
      <add position="after">
        <![CDATA[
      <tr id="ctnfiltroUnidade" style="display: none;">
        <td>
          <b>Unidade:</b>
        </td>
        <td>
          <?php
            db_select("filtroUnidade", $afiltroUnidade, true, 1, "onchange=\"js_recarregaIframeMovimentos();\"");
          ?>
        </td>
      </tr>
        ]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[<input name="atualizar" type="submit"]]></search>
      <add position="replace">
        <![CDATA[<input id="btnAtualizar" name="atualizar" type="submit"]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[<input name="desatualizar" type="submit"]]></search>
      <add position="replace">
        <![CDATA[<input id="btnDesatualizar" name="desatualizar" type="submit"]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[<!-- [Inicio plugin GeracaoArquivoOBN  - Filtros Emissao Arquivo OBN - parte11] -->
  <iframe name         ="ordem"
          src          ='emp4_empageconfgera001_ordem.php?db_banco=<?=(@$db_bancos)?>&comboboxCNPJ=<?php echo $_POST['comboboxCNPJ'];?>&filtroTipoTransmissao=<?php echo $_POST['filtroTipoTransmissao'];?>']]></search>
      <add position="replace">
        <![CDATA[
  <!-- [Inicio plugin GeracaoArquivoOBN  - Filtros Emissao Arquivo OBN - parte11] -->
  <input id="unidades" type="hidden" size = "50" name='unidades'>
  <iframe name         ="ordem"
          id           ="ordem" 
          src          ='emp4_empageconfgera001_ordem.php?db_banco=<?=(@$db_bancos)?>&comboboxCNPJ=<?php echo $_POST['comboboxCNPJ'];?>&filtroTipoTransmissao=<?=$filtroTipoTransmissao?>&filtroUnidade=<?=$filtroUnidade?>']]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Filtros Emissao Arquivo OBN - parte12] */]]></search>
      <add position="after">
        <![CDATA[
var lMostraFiltroUnidade = <?= !isset($geraUnidade)?"true":"false"; ?>;

window.onload = function() {
  js_inicializarUnidades();
  if ($F("filtroTipoTransmissao") == 2 && lMostraFiltroUnidade) {
      $('ctnfiltroUnidade').show();
  } else {
      $('ctnfiltroUnidade').hide();
  } 
}  

function js_inicializarUnidades() {
  js_divCarregando("Aguarde, carregando os dados...", "msgBox");

  var listaUnidades = JSON.stringify(<?=db_getsession("geracao_txt_unidades", false)?>);
  if(!listaUnidades) {
    $('unidades').value = $('ordem').contentWindow.document.forms['form1'].unidades.value;
  }
  else {
    $('unidades').value = listaUnidades;
  }
  js_MontaOptionsSelectUnidade();
}

function js_MontaOptionsSelectUnidade() {

  
  js_removeObj("msgBox");
  
  var objSelect = document.getElementById("filtroUnidade");
  var objUnidades = $('unidades').value;
  var unidades = JSON.parse(objUnidades);
  
  while (objSelect.options.length > 0){
    objSelect.remove(0);
  }

  for (var i in unidades) {
    if(unidades[i]) {
      var option = document.createElement("option");
      var unidade = unidades[i].split("|");
      option.value = unidade[0];
      option.text  = ((unidade[0]).replace(":", " - ")+' - '+unidade[1]).urlDecode(); 
      objSelect.add(option);
    }
  }
  if((localStorage.getItem("selectedUnidade"))){
    objSelect.selectedIndex = localStorage.getItem("selectedUnidade");
    localStorage.removeItem("selectedUnidade");
  }
  js_recarregaIframeMovimentos();
}
        ]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Filtros Emissao Arquivo OBN - parte13] */     
function js_recarregaIframeMovimentos() {
  $$('iframe[name="ordem"]')[0].contentDocument.location = 'emp4_empageconfgera001_ordem.php?db_banco=&comboboxCNPJ=&filtroTipoTransmissao=';]]></search>
      <add position="replace">
        <![CDATA[
/* [Inicio plugin GeracaoArquivoOBN  - Filtros Emissao Arquivo OBN - parte13] */     
function js_recarregaIframeMovimentos() {

  <? if (isset($geraUnidade)) { ?>
    $$('iframe[name="ordem"]')[0].contentDocument.location = 'emp4_empageconfgera001_ordem.php?geraUnidade&db_banco=&comboboxCNPJ=&filtroTipoTransmissao='+$F(filtroTipoTransmissao)+'&filtroUnidade='+$F(filtroUnidade);
  <? } else { ?>
    $$('iframe[name="ordem"]')[0].contentDocument.location = 'emp4_empageconfgera001_ordem.php?db_banco=&comboboxCNPJ=&filtroTipoTransmissao='+$F(filtroTipoTransmissao)+'&filtroUnidade='+$F(filtroUnidade);
  <? } ?>
  objAtualizar = document.getElementById("btnAtualizar");
  objDesatualizar = document.getElementById("btnDesatualizar");

  if ($F("filtroTipoTransmissao") == 2 && lMostraFiltroUnidade) {
    $('ctnfiltroUnidade').show();
  } else {
    $('ctnfiltroUnidade').hide();
  }  

  objAtualizar.disabled = false;
  objDesatualizar.disabled = false;
          
        ]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Filtros Emissao Arquivo OBN - parte14] */      
  if ($F('comboboxCNPJ') == "0") {

    alert("Selecione um CNPJ para carregar os movimentos bancários.");
    return false;
  }]]></search>
      <add position="replace">
        <![CDATA[
        /* [Inicio plugin GeracaoArquivoOBN  - Filtros Emissao Arquivo OBN - parte14] */
        /*
        if ($F('comboboxCNPJ') == "0") {

          alert("Selecione um CNPJ para carregar os movimentos bancários.");
          return false;
        }*/ 
        ]]>
      </add>
    </operation>
    
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Filtros Emissao Arquivo OBN - parte15] */]]></search>
      <add position="after">
        <![CDATA[
  var objSelect = document.getElementById("filtroUnidade");
  var selected = objSelect.selectedIndex;
  localStorage.setItem("selectedUnidade", selected);
        ]]>
      </add>
    </operation>

   /* 
    <operation>
      <search><![CDATA[if (oRetorno.iStatus == '1') {

    var pArquivo = oRetorno.sArquivo+"# Download do Arquivo - "+ oRetorno.sArquivo;
    js_montarlista(pArquivo, 'form1');
  } else {
    alert(oRetorno.sMessage.urlDecode());
  }]]></search>
      <add position="replace">
        <![CDATA[if(!lMostraFiltroUnidade) {
    var emiteComprovante = confirm("Os arquivos foram gerados com sucesso.\n Código da Remessa: "+oRetorno.iCodigoRemessa+" \n Deseja emitir o comprovante?");
    if (emiteComprovante) {
      jan = window.open('emp2_gerarq002.php?lCancelado=0&e87_codgera='+oRetorno.iCodigoRemessa+'','width='+(screen.availWidth-5)+',height='+(screen.availHeight-40)+',scrollbars=1,location=0 ');
    }
  } else {
    if (oRetorno.iStatus == '1') {
      var pArquivo = oRetorno.sArquivo+"# Download do Arquivo - "+ oRetorno.sArquivo;
      js_montarlista(pArquivo, 'form1');
    } else {
      alert(oRetorno.sMessage.urlDecode());
    }
  }]]>
      </add>
    </operation>
*/
    
  </file>
  
  <file path='cai4_arquivoBanco004.RPC.php'>
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN  - Salvar Geracao Arquivo TXT OBN - parte1] */]]></search>
      <add position="after">
        <![CDATA[
        $oGeradorArquivoOBN->salvarGeracaoTxtArquivo();
        ]]>
      </add>
    </operation>
  </file>  
  
  <file path='forms/db_frmmanutencaoagenda.php'>
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN - Efetuar pagamento DEB ou DIN - parte1] */
    var sCombo  = "<select style='width:100%' class='formapag' id='forma"+iCodMov+"' "+sDisabled+">";]]></search>
      <add position="replace">
        <![CDATA[
    /* [Inicio plugin GeracaoArquivoOBN - Efetuar pagamento DEB ou DIN - parte1] */
    var sCombo  = "<select style='width:100%' class='formapag' id='forma"+iCodMov+"' "+sDisabled+" onchange='js_formaPagamentoAlterada(this.value)'>";]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN - Efetuar pagamento DEB ou DIN - parte2] */]]></search>
      <add position="after">
        <![CDATA[
  function js_formaPagamentoAlterada(formaPagamento){
    
    if((formaPagamento == 1 || formaPagamento == 4) && $('efetuarpagamento').checked == false){
      document.getElementById("efetuarpagamento").click(); 
      $('autenticar').checked = false;
    }  
  }]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[<input name="emitetxt" id='emitetxt' type="button"
                   value='Emitir Arquivo Texto' onclick='location.href="emp4_empageconfgera001.php"' />]]></search>
      <add position="replace">
        <![CDATA[<input name="emitetxt" id='emitetxt' type="button"
                   value='Emitir Arquivo Texto' onclick='location.href="emp4_empageconfgera001.php?geraUnidade"' />]]>
      </add>
    </operation>
  </file>

  <file path='forms/db_frmmanutencaoagendaslip.php'>
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN - Efetuar pagamento DEB ou DIN - parte1] */
    var sCombo  = "<select style='width:100%' class='formapag' id='forma"+iCodMov+"' "+sDisabled+">";]]></search>
      <add position="replace">
        <![CDATA[
    /* [Inicio plugin GeracaoArquivoOBN - Efetuar pagamento DEB ou DIN - parte1] */
    var sCombo  = "<select style='width:100%' class='formapag' id='forma"+iCodMov+"' "+sDisabled+" onchange='js_formaPagamentoAlterada(this.value)'>";]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN - Efetuar pagamento DEB ou DIN - parte2] */]]></search>
      <add position="after">
        <![CDATA[
  function js_formaPagamentoAlterada(formaPagamento){
    
    if((formaPagamento == 1 || formaPagamento == 4) && $('efetuarpagamento').checked == false){
      document.getElementById("efetuarpagamento").click(); 
      $('autenticar').checked = false;
    }  
  }]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[<input name="emitetxt" id='emitetxt' type="button"  value='Emitir Arquivo Texto' onclick='location.href="emp4_empageconfgera001.php"'>]]></search>
      <add position="replace">
        <![CDATA[<input name="emitetxt" id='emitetxt' type="button"  value='Emitir Arquivo Texto' onclick='location.href="emp4_empageconfgera001.php?geraUnidade"'>]]>
      </add>
    </operation>

  </file>

  <file path='emp4_manutencaoslips001.php'>
    <operation>
      <search><![CDATA[require_once("forms/db_frmmanutencaoagendaslip.php");]]></search>
      <add position="replace">
        <![CDATA[require_once(Modification::getFile("forms/db_frmmanutencaoagendaslip.php"));]]>
      </add>
    </operation>
  </file>

  <file path='cai2_retornobanco002.php'>
    <operation>
      <search><![CDATA[$dbwhere = " e75_codret = ".$retorno . " and e75_ativo is true and e90_cancelado is false ";]]></search>
      <add position="replace">
        <![CDATA[$dbwhere = " e80_instit = " . db_getsession("DB_instit") . " and e75_codret = ".$retorno . " and e75_ativo is true and (case when empageconfgera.e90_codmov is not null then empageconfgera.e90_cancelado is false else true end) ";]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[$sTextoOcorrencia .= "{$sVirgula}{$oOcorrencia->e92_descrerro}";]]></search>
      <add position="replace">
        <![CDATA[$oObs = db_utils::fieldsMemory($result_retorno,$i);
      $sTextoOcorrencia .= "{$sVirgula}{$oOcorrencia->e92_descrerro} - {$oObs->observacao}";]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[                                                fc_valorretencaomov(e81_codmov, true,e87_dataproc) as vlrretencao,
                                                e83_codtipo,
                                                e83_descr",]]></search>
      <add position="replace">
        <![CDATA[                                                fc_valorretencaomov(e81_codmov, true,e87_dataproc) as vlrretencao,
                                                e83_codtipo,
                                                e83_descr,
                                                (select 
                                                  observacao 
                                                from plugins.empagedadosretmovocorrenciaobservacao 
                                                where empagedadosretmovocorrencia = empagedadosretmovocorrencia.e02_sequencial)",]]>
      </add>
    </operation>
  </file>

  <file path='cai1_planilhalancamento001.php'>
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN - Planilha de lançamento dedução - parte1] */]]></search>
      <add position="after">
        <![CDATA[
  if ($('estrutural').value.substr(0,1) == '9') {
    $('k81_valor').value = "-";
  } else {
    $('k81_valor').value = "";
  }]]>
      </add>
    </operation>
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN - Planilha de lançamento dedução - parte2] */]]></search>
      <add position="after">
        <![CDATA[
  var ContaReceitaLanc;
  var ContaLanc;
  for (var i = aContasReceita.length - 1; i >= 0; i--) {
    ContaReceitaLanc = (aContasReceita[i] == $F('k81_receita') ? true : false);
  }

  for (var i = aContas.length - 1; i >= 0; i--) {
    ContaLanc = (aContas[i] == $F('k81_conta') ? true : false);
  }

  if (ContaReceitaLanc && ContaLanc) {
    alert("Já foi inserida uma receita para essa conta.");
    return false;
  }]]>
      </add>
    </operation>
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN - Planilha de lançamento dedução - parte3] */]]></search>
      <add position="after">
        <![CDATA[
 var aContasReceita = new Array();
 var aContas = new Array();]]>
      </add>
    </operation>
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN - Planilha de lançamento dedução - parte4] */]]></search>
      <add position="after">
        <![CDATA[
  aContasReceita.push($F('k81_receita'));]]>
      </add>
    </operation>
    <operation>
      <search><![CDATA[/* [Inicio plugin GeracaoArquivoOBN - Planilha de lançamento dedução - parte5] */]]></search>
      <add position="after">
        <![CDATA[
  aContas.push($F('k81_conta'));]]>
      </add>
    </operation>
  </file>

  <file path='emp4_empageretornoconf001.php'>

    <operation>
      <search><![CDATA[<td align="left">
          <strong>Data da Baixa:</strong>
          <?php db_inputdata('data_baixa', date('d', db_getsession("DB_datausu")), date('m', db_getsession("DB_datausu")), date('Y', db_getsession("DB_datausu")), true, 'text', 1); ?>
        </td>]]></search>
      <add position="replace">
        <![CDATA[<td></td>]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[$oDataSistema = new DBDate($data_baixa);]]></search>
      <add position="replace">
        <![CDATA[]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[$sSqlDadosEmpagedadosretmov = $clempagedadosretmov->sql_query_file(null,null,"e76_codret, e76_codmov",null,$sWhere);]]></search>
      <add position="replace">
        <![CDATA[$sSqlDadosEmpagedadosretmov = $clempagedadosretmov->sql_query_file(null,null,"e76_codret, e76_codmov, e76_dataefet",null,$sWhere);]]>
      </add>
    </operation>

    <operation>
      <search><![CDATA[$movimento  = $oDados->e76_codmov;]]></search>
      <add position="after">
        <![CDATA[
    $oDataSistema = new DBDate($oDados->e76_dataefet);
        ]]>
      </add>
    </operation>
  </file>
</modification>
